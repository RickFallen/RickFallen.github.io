<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="PHP,CI,CodeIgniter," />








  <link rel="shortcut icon" type="image/x-icon" href="/res/img/favicon.ico?v=5.0.1" />






<meta name="description" content="本人因公司需求.学习PHP的CI框架.本博文为学习笔记.CodeIgniter 是一套给 PHP 网站开发者使用的应用程序开发框架和工具包。它提供一套丰富的标准库以及简单的接口和逻辑结构，其目的是使开发人员更快速地进行项目开发。使用 CodeIgniter 可以减少代码的编写量，并将你的精力投入到项目的创造性开发上。
其中内容包括,CI_Controller对象 , 数据库访问 , AR模型(QB">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP学习笔记-CI框架">
<meta property="og:url" content="http://comtu.github.com/2015/09/10/PHP_codeigniter.html">
<meta property="og:site_name" content="Comtu">
<meta property="og:description" content="本人因公司需求.学习PHP的CI框架.本博文为学习笔记.CodeIgniter 是一套给 PHP 网站开发者使用的应用程序开发框架和工具包。它提供一套丰富的标准库以及简单的接口和逻辑结构，其目的是使开发人员更快速地进行项目开发。使用 CodeIgniter 可以减少代码的编写量，并将你的精力投入到项目的创造性开发上。
其中内容包括,CI_Controller对象 , 数据库访问 , AR模型(QB">
<meta property="og:updated_time" content="2016-09-30T03:14:34.708Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHP学习笔记-CI框架">
<meta name="twitter:description" content="本人因公司需求.学习PHP的CI框架.本博文为学习笔记.CodeIgniter 是一套给 PHP 网站开发者使用的应用程序开发框架和工具包。它提供一套丰富的标准库以及简单的接口和逻辑结构，其目的是使开发人员更快速地进行项目开发。使用 CodeIgniter 可以减少代码的编写量，并将你的精力投入到项目的创造性开发上。
其中内容包括,CI_Controller对象 , 数据库访问 , AR模型(QB">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 9414502,
      author: 'Comtu'
    }
  };
</script>




  <link rel="canonical" href="http://comtu.github.com/2015/09/10/PHP_codeigniter.html"/>

  <title> PHP学习笔记-CI框架 | Comtu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e0d9a75a7e53b54cd1e6649facd5906e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Comtu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                PHP学习笔记-CI框架
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-09-10T00:00:00+08:00" content="2015-09-10">
              2015-09-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/09/10/PHP_codeigniter.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="/2015/09/10/PHP_codeigniter.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2015/09/10/PHP_codeigniter.html" class="leancloud_visitors" data-flag-title="PHP学习笔记-CI框架">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本人因公司需求.学习PHP的CI框架.本博文为学习笔记.<br>CodeIgniter 是一套给 PHP 网站开发者使用的应用程序开发框架和工具包。<br>它提供一套丰富的标准库以及简单的接口和逻辑结构，其目的是使开发人员更快速地进行项目开发。<br>使用 CodeIgniter 可以减少代码的编写量，并将你的精力投入到项目的创造性开发上。</p>
<p>其中内容包括,CI_Controller对象 , 数据库访问 , AR模型(QB模型) , CI类库扩展 ,<br>Url相关函数 , 设置路由 , 隐藏入口文件, 分页 , 文件上传 , Session , 验证码 , 语言包 , CI框架内部解析等内容.</p>
<a id="more"></a>
<p>目录</p>
<ul>
<li><a href="#CodeIgniter框架简介">CodeIgniter框架简介</a></li>
<li><a href="#MVC">MVC</a><ul>
<li><a href="#控制器-controllers">控制器-controllers</a></li>
<li><a href="#视图-views">视图-views</a> </li>
<li><a href="#模型-model">模型-model</a></li>
</ul>
</li>
<li><a href="#CI的超级对象-(CI的控制器对象CI_Controller">CI的超级对象-(CI的控制器对象CI_Controller)</a>)</li>
<li><a href="#数据库访问">数据库访问</a></li>
<li><a href="#AR模型操作数据库">AR模型操作数据库增删改查 active_record (CI3.0之后改名 query_builder QB模型)</a></li>
<li><a href="#CI类库扩展">CI类库扩展</a><ul>
<li><a href="#扩展控制器CI_Controller-装载器Loader">为网站设计不同的主题.前台,后台(扩展控制器CI_Controller,装载器Loader)</a></li>
<li><a href="#扩展CI的captcha_helper.php实现_验证码">扩展CI的captcha<em>helper.php实现</em>验证码</a></li>
<li><a href="#扩展_修改分页生成的代码">扩展_修改分页生成的代码</a></li>
</ul>
</li>
<li><a href="#url相关函数">url相关函数</a></li>
<li><a href="#设置路由">设置路由</a></li>
<li><a href="#隐藏入口文件-index.php">隐藏入口文件-index.php</a></li>
<li><a href="#分页">分页</a></li>
<li><a href="#文件上传">文件上传</a></li>
<li><a href="#图片处理类">图片处理类</a></li>
<li><a href="#Session">Session</a></li>
<li><a href="#验证码">验证码</a></li>
<li><a href="#表单验证">表单验证</a></li>
<li><a href="#语言包">语言包</a></li>
<li><a href="#购物车类库">购物车类库</a></li>
<li><a href="#CI框架内部解析">CI框架内部解析</a></li>
</ul>
<hr>
<p>注:测试版本为CodeIgniter3.0.0框架 与CI2.x的有些不同.<br>但都有标注不同点以及处理方法.笔记理论上基本适用于3.0.0(当前最新)之前的版本.  </p>
<p>中文教程地址:<br><a href="http://codeigniter.org.cn/user_guide/index.html" target="_blank" rel="external">http://codeigniter.org.cn/user_guide/index.html</a></p>
<h1 id="CodeIgniter框架简介-CI框架"><a href="#CodeIgniter框架简介-CI框架" class="headerlink" title="CodeIgniter框架简介 ( CI框架 )"></a><a id="CodeIgniter框架简介"></a>CodeIgniter框架简介 ( CI框架 )</h1><pre><code>CodeIgniter是一个轻量级但功能强大的PHP框架是基于MVC设计模式.

框架开发和二次开发
    打个比方:买房子
    买二手房,直接拎包入住 , 好比二次开发,如:dedecms,PHPCMS(内容管理系统),ECShop(开源免费的网上商店系统)
    买毛坯房,不能住人,自己去买各种装修材料,请人装修,才能入住.好比框架开发.只提供
    基础功能和项目结构.

    CI是框架,用于框架开发.

目录结构说明:
    license.txt许可协议
    user_guide 用户手册(一般删除)
    index.php 入口文件
    system 框架核心代码,通常不动的.
    application 应用目录
    |-- cache        缓存目录
    |-- config       配置文件目录
    |-- controllers  控制器文件夹
    |-- core         核心库扩展目录
    |-- errors       错误页面
    |-- helpers      自定义辅助函数文件夹
    |-- hooks        勾子文件夹
    |-- language     语言包
    |-- libraries    自定义库文件夹,通常是一些类文件
    |-- logs         日志
    |-- models       模型文件夹
    |-- third_party  第三方库目录,如smarty
    |-- views        视图文件夹
</code></pre><h1 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a><a id="MVC"></a>MVC</h1><pre><code>1. 入口文件 
    唯一一个让浏览器直接请求的脚本文件

2. 控制器 controller
    协调模型和视图

3. 模型 model 
    提供数据,保存数据,数据有效性认证

4. 视图 view
    只负责显示,以及表单...

5. 动作 action 
    是控制器中方法,用户被浏览器直接请求

访问url使用的是pathinfo //http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/welcome/test  test是welcome的一个方法

入口文件.php/控制器/动作

application 应用目录
    controllers 控制器
    models 模型
    views 视图

默认控制器是welcome
默认动作是index 
</code></pre><h2 id="控制器-controllers"><a href="#控制器-controllers" class="headerlink" title="控制器-controllers"></a><a id="控制器-controllers"></a>控制器-controllers</h2><pre><code>1.不需要加后缀 , 直接是类名.php (自己编写的控制器需要UserController.php)
2.文件名全部小写 
3.所有的控制器,直接或者间接继承自 CI_Controller 类
4.尽量不要使用Index名作为控制器类名,因为与方法index与类名相同的,会被PHP当作构造方法void __construct(){}
5.控制器中, 动作(函数,方法)要求:
    public 
    不能以_开头

    //不能被浏览器范围
    protected function test() {
        echo &apos;test&apos;;
    }

    //以下划线开头的方法,不能被浏览器请求
    public function _test1() {
        echo &apos;test1&apos;;
    }

    public function test2(){
        $this-&gt;_test1();
    }
</code></pre><h2 id="视图-views"><a href="#视图-views" class="headerlink" title="视图-views"></a><a id="视图-views"></a>视图-views</h2><pre><code>1.在控制器中如果加载视图
    //直接写试图名字,不写扩展名,如果有子目录,则写上目录名
    $this-&gt;load-&gt;view ( &apos;user/index&apos; ); //表示user目录下的index.php文件
    可以多次调用$this-&gt;load-&gt;view (视图); 

2.试图中,直接使用原生PHP代码
3.推荐使用
    &lt;?php foreach ($list as $item):?&gt;
    &lt;?=$item[&quot;email&quot;]?&gt;
    &lt;?php endforeach;?&gt;

    &lt;?php if(empty($carts)):?&gt;
    &lt;?php else:?&gt;
    &lt;?php endif;?&gt;
</code></pre><h2 id="模型-model"><a href="#模型-model" class="headerlink" title="模型-model"></a><a id="模型-model"></a>模型-model</h2><pre><code>模型文件名全部使用小写,建议使用_model为后缀,防止与控制器类名冲突,但里面的类名首字母大写
在模型中,可以直接使用超级对象中的属性

\application\models\user_model.php 模型
    &lt;?php
        class User_model extends CI_Model{//继承自 CI_Model
            //返回所有用户
            public function getAll(){
                $res = $this-&gt;db-&gt;get(&apos;user&apos;);//在模型中,可以直接使用超级对象中的属性
                return $res;
            }
        }
\application\controllers\my_model_demo.php 控制器
    &lt;?php
        class My_model_demo extends CI_Controller {
            // http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/my_model_demo
            public function index() {
                // 加载模型,加载后将自动成为超级对象的属性
                // $this-&gt;load-&gt;model ( &apos;User_model&apos; );
                $this-&gt;load-&gt;model ( &apos;User_model&apos;, &apos;user&apos; ); // 起个别名

                // 调用模型获取数据
                // $list = $this-&gt;User_model-&gt;getAll();
                $list = $this-&gt;user-&gt;getAll (); // 使用别名

                // 加载视图
                $this-&gt;load-&gt;view ( &apos;user/my_model_view_demo&apos;, array (&apos;list&apos; =&gt; $list ) );
            }
        }
\application\views\user\my_model_view_demo.php 视图
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;View&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;?php 
        //CI它使用了一个 extract 函数,将数组变量导入到当前的符号表,所以直接使用键名作为变量来访问
            var_dump( $list); 
        ?&gt;
    &lt;/body&gt;
    &lt;/html&gt;

建议使用这种这种MVC架构来编写代码,可维护性高一些.
</code></pre><h1 id="CI的超级对象-CI的控制器对象CI-Controller"><a href="#CI的超级对象-CI的控制器对象CI-Controller" class="headerlink" title="CI的超级对象-(CI的控制器对象CI_Controller)"></a><a id="CI的超级对象-(CI的控制器对象CI_Controller)"></a>CI的超级对象-(CI的控制器对象CI_Controller)</h1><pre><code>当前的控制器对象
属性
$this-&gt;load //  --&gt; system/core/CI_Loader类装载器,类的加载,如视图,控制器等
    装载器类的实例system/core/CI_Loader.php
    装载器CI_Loader提供方法:
        view()    装载视图
        vars()  分配变量到视图
        database()  装载数据库操作对象
        model()  装载模型
        helper() 一些辅助函数

$this-&gt;uri // 获取url参数等功能
    是CI_URI类的实例 --&gt; system/core/CI_URI.php 
    CI_URI类提供方法:
        segment(n) 用于获取url中的第几个参数(值）
        传统的: 入口文件.php/控制器/动作/参数1/值1/参数2/值2
        CI的  : 入口文件.php/控制器/动作/值1/值2

        echo $this-&gt;segment(3);//值1
        echo $this-&gt;segment(4);//值2

        方式一: 
        // 使用CI的pathinfo
        // http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/user/testURI/4
        echo $this-&gt;uri-&gt;segment(3); // 获取URI第几段的参数 可取得4 , 从user开始计算1,2,3

        方式一: 
        直接写在方法里面
        http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/user/testURI2/1/jack
        public function index($id = 0,$name=&apos;&apos;){ //可以直接获取到id=1 ; name= jack ,如果id没有输入默认为0,默认name为空
            echo $id;//1
            echo $name; // jack
        }

$this-&gt;input 获取用户输入信息 如,get put cookie等
    是CI_Input类的实例 --&gt; system/core/CI_Input.php
    CI_Input类提供方法:
        $this-&gt;input-&gt;post(&apos;username&apos;);         //$_POST[&apos;username&apos;]
        $this-&gt;input-&gt;post(&apos;username&apos;,true);    //跨站脚本（XSS）过滤
        $this-&gt;input-&gt;server(&apos;DOCUMENT_ROOT&apos;);    //$_SERVER[&apos;DOCUMENT_ROOT&apos;]
        $this-&gt;input-&gt;cookie();
        $this-&gt;input-&gt;server()
        ...

在视图(view)中,直接使用$this来访问超级对象中的属性

CI支持控制器在子目录中.
    如果你在建立一个大型的应用程序，你会发现 CodeIgniter 可以很方便的将控制器放到一些子文件夹中。

    只要在 application/controllers 目录下创建文件夹并放入你的控制器就可以了。

    注意：  如果你要使用某个子文件夹下的功能，就要保证 URI 的第一个片段是用于描述这个文件夹的。例如说你有一个控制器在这里：

    application/controllers/products/shoes.php

    调用这个控制器的时候你的 URI 要这么写：

    example.com/index.php/products/shoes/show/123

    你的每个子文件夹中需要包含一个默认的控制器，这样如果 URI 中只有子文件夹而没有具体功能的时候它将被调用。
    只要将你作为默认的控制器名称在 application/config/routes.php 文件中指定就可以了。

    CodeIgniter 也允许你使用 URI 路由 功能来重新定向 URI。
</code></pre><h1 id="数据库访问"><a href="#数据库访问" class="headerlink" title="数据库访问"></a><a id="数据库访问"></a>数据库访问</h1><pre><code>配置数据库文件
    可在 \system\database\drivers\目录下查看可被支持的数据库驱动
    application/config/database.php 数据库配置文件
    $db[&apos;default&apos;]= array(    //&apos;default&apos;表示默认数据库,当一个项目需要连接多个数据库的时候,可以增加多一个$db[&apos;新数据库别名&apos;]= array(....
        &apos;hostname&apos; =&gt; &apos;localhost&apos;,
        &apos;username&apos; =&gt; &apos;root&apos;,
        &apos;password&apos; =&gt; &apos;root&apos;,
        &apos;database&apos; =&gt; &apos;test&apos;,    //database数据库名
        &apos;dbdriver&apos; =&gt; &apos;mysql&apos;, //数据库驱动
        &apos;dbprefix&apos; =&gt; &apos;blog_&apos;, //表前缀 
        &apos;swap_pre&apos; =&gt; &apos;swap_&apos;, //表前缀 假设代码里面的都是使用swap_的前缀,而表是使用blog_前缀,则会自动替换成dbprefix的前缀,而无需修改源代码
    );

    表前缀
        &apos;dbprefix&apos; =&gt; &apos;blog_&apos;, 
        &apos;swap_pre&apos; =&gt; &apos;blog_&apos;, 
        配置为一样,代码中,直接硬编码表前缀就行了,如果以后项目数据库表前缀发生变化,
        只需要修改&apos;dbprefix&apos; =&gt; &apos;new_&apos;,  代码中的blog_会自动替换为new_

    /////数据库附件/////

将数据库访问对象,装载到超级对象的属性中 $this-&gt;db
    方式一(PHP代码手动加载): 
        // 装载一个数据库操作类
        $this-&gt;load-&gt;database();//表示连接默认数据库
        //一个项目多个数据库时,表示连接其它数据库,配置文件\application\config\database.php中配置相对应别名
        //$this-&gt;load-&gt;database(&apos;新数据库别名&apos;);
    方式二(配置文件,自动加载):
        //因为每次使用数据库的时候都需要装载数据库操作类,所以在配置文件\application\config\autoload.php中配
        //置Auto-load Libraries 自动加载项,以后就可以不再需要手动加载,但对于多个数据库的还是需要指定数据库.
        //$autoload[&apos;libraries&apos;] = array(&apos;database&apos;);//自动加载配置
        //$this-&gt;load-&gt;database();//以后编写都不需要这行代码.

    使用: 
        //装载成功后,会放入超级对象的属性中, 默认属性名是db
        // var_dump($this-&gt;db);//$this-&gt;db 返回的是 CI_DB_mysql_driver 对象 继承自 CI_DB

    CI_DB_mysql_driver 对象 --&gt; \system\database\drivers\mysql\mysql_driver.php  

$this-&gt;db-&gt;query()方法 增删改查
    查询数据 返回的是一个对象
        $sql = &apos;select * from blog_user&apos;;
        // 返回的是CI_DB_mysql_result 对象 - mysql_query()
        $res = $this-&gt;db-&gt;query ( $sql ); //返回的是 CI_DB_mysql_result 对象 继承自 CI_DB_result
        $res-&gt;result();//返回数组,数组中是一个一个的对象
        $res-&gt;result_array();//返回二维数组,里面是关联数组
        $res-&gt;row();//返回第一条数据,直接是一个对象

        //帮助文档中--&gt; 数据库类--&gt;查询--&gt;query 
        //帮助文档中--&gt; 数据库类--&gt;生成查询结果集--&gt; result_array() 等等的一些方法. 调用方法就如上所示
        //以上可取得如下php原生函数类似的结果
        //mysql_fetch_assoc()//关联数组 //http://www.w3school.com.cn/php/func_mysql_fetch_assoc.asp
        //mysql_fetch_object()//返回对象 //http://www.w3school.com.cn/php/func_mysql_fetch_object.asp

        CI_DB_mysql_result 对象 --&gt; \system\database\drivers\mysql\mysql_result.php

    增删改数据 返回一个 boolean 布尔值

        // 插入数据
        // $name=$this-&gt;input-&gt;post(&apos;name&apos;);//假如获取用户post过来的数据.
        // $name = &apos;lili&apos;;
        // $pass = &apos;lili&apos;;

        // $data [0] = $name;
        // $data [1] = $pass;
        ////参数绑定:
        // $sql = &quot;insert into blog_user (name,password) values (?,me5(?))&quot;;
        // $bool = $this-&gt;db-&gt;query ( $sql, $data );//多个问号?参数时,需要传入一个索引数组

        // 删除数据
        // $sql = &quot;delete from blog_user where id=?&quot;;
        // $bool = $this-&gt;db-&gt;query ( $sql, 2 );

        // 修改数据
        $data [0] = &apos;mary@gmail.com&apos;;
        $data [1] = 3;
        $sql = &quot;update blog_user set email = ? where id=? &quot;;
        $bool = $this-&gt;db-&gt;query ( $sql, $data );

        if ($bool) {
            // mysql_affected_rows
            echo &apos;受影响行数:&apos; . $this-&gt;db-&gt;affected_rows ();
            echo &apos;自增ID:&apos; . $this-&gt;db-&gt;insert_id ();
        }
    使用CI的db增加改查都是使用$this-&gt;db-&gt;query()来进行处理.
</code></pre><h1 id="AR模型操作数据库-active-record-CI3-0之后改名-query-builder-QB模型"><a href="#AR模型操作数据库-active-record-CI3-0之后改名-query-builder-QB模型" class="headerlink" title="AR模型操作数据库 active_record (CI3.0之后改名 query_builder QB模型)"></a><a id="AR模型操作数据库"></a>AR模型操作数据库 active_record (CI3.0之后改名 query_builder QB模型)</h1><pre><code>配置
    \application\config\database.php 配置开启AR/QB模型(默认TRUE)
        $active_record = TRUE; 配置为TRUE表示开启这项功能. (AR模型_2.2.0)
        $query_builder = TRUE; 配置为TRUE表示开启这项功能. (QB模型_3.0.0)

        \system\database\DB_active_rec.php (为AR模型原代码_2.2.0)
        \system\database\DB_query_builder.php (为QB模型的原代码_2.2.0)

    \application\config\autoload.php 配置自动加载
        $autoload[&apos;libraries&apos;] = array(&apos;database&apos;);

使用增删改查
    在配置文件中,配置表前缀后,会自动添加前缀.

    插入:
        $bool = $this-&gt;db-&gt;insert(&apos;表名&apos;,关联数组);

        //TODO 通过AR/QB模型增加数据内容 insert 增加
        $data  = array(
            &apos;name&apos;=&gt;&apos;lili&apos;,
            &apos;password&apos;=&gt;md5(&apos;lili&apos;)            
        );
        const TBL = &apos;user&apos;;//表名,常量
        $bool = $this-&gt;db-&gt;insert(self::TBL,$data);
        var_dump($bool);
        echo &apos;&lt;hr&gt;&apos;;

    更新:
        $bool = $this-&gt;db-&gt;update(&apos;表名&apos;,关联数组,条件);

        //TODO 通过AR/QB模型更新数据 update 更新
        $data = array(
                &apos;email&apos;=&gt;&apos;lili@gmail.com&apos;,
                &apos;password&apos;=&gt;md5(&apos;123456&apos;),
        );
        $bool =$this-&gt;db-&gt;update(&apos;user&apos;,$data,array(&apos;id&apos;=&gt;4));
        var_dump($bool);

    删除:
        $bool = $this-&gt;db-&gt;delete(&apos;表名&apos;,条件);

        //TODO 通过AR/QB模型删除数据 delete 删除
        $bool = $this-&gt;db-&gt;delete(&apos;user&apos;,array(&apos;id&apos;=&gt;4));
        var_dump($bool);

    查询:
        $res = $this-&gt;db-&gt;get(&apos;表名&apos;,[&apos;条件&apos;]);//返回结果集对象. &apos;表名&apos;会自动增加为&apos;blog_表名&apos;
        $res-&gt;result();//结合返回获取数据

        //TODO 通过AR/QB模型获取数据表内容-查询
        $res = $this-&gt;db-&gt;get ( &apos;user&apos; );//AR模型可以自动处理表前缀.并直接获取bolg_user表的数据

        var_dump($res);
        echo &apos;&lt;hr&gt;&apos;;
        foreach ($res-&gt;result() as $item){
            echo $item-&gt;name;
            echo &apos;  &apos;;
            echo $item-&gt;password;
            echo &apos;  &apos;;
            echo $item-&gt;email;
            echo &apos;&lt;br&gt;&apos;;
        }

    连贯查询
        //TODO 连贯查询
        //SELECT `id`, `name` FROM `blog_user` WHERE `id` &gt;= 3 ORDER BY `id` desc LIMIT 2, 3
        $res = $this-&gt;db-&gt;select(&apos;id,name&apos;)//
        -&gt;from(&apos;user&apos;)//表名
        -&gt;where(&apos;id &gt;=&apos; , 3)//&apos;id &gt;=&apos; 符号前面需要一个空格,如果符号不写默认&apos;=&apos;等于
        -&gt;limit(3,2)//跳过2条,取后3条数据
        -&gt;order_by(&apos;id desc&apos;)//通过id倒序
        -&gt;get();//获取数据

        var_dump($res-&gt;result());
        echo &apos;&lt;br&gt;&apos;;
        echo $this-&gt;db-&gt;last_query();//显示最后一条执行的SQL语句
        //SELECT `id`, `name` FROM `blog_user` WHERE `id` &gt;= 3 ORDER BY `id` desc LIMIT 2, 3

        更多where查询条件 
            //SELECT * FROM `blog_user` WHERE `name` = &apos;mary&apos;
            $res = $this-&gt;db-&gt;where(&apos;name&apos;,&apos;mary&apos;)-&gt;get (&apos;user&apos;);
            //SELECT * FROM `blog_user` WHERE `name` != &apos;mary&apos;
            $res = $this-&gt;db-&gt;where(&apos;name !=&apos;,&apos;mary&apos;)-&gt;get (&apos;user&apos;);
            //SELECT * FROM `blog_user` WHERE `name` = &apos;mary&apos;
            $res = $this-&gt;db-&gt;where(array(&apos;name&apos;=&gt;&apos;mary&apos;))-&gt;get (&apos;user&apos;);
            //SELECT * FROM `blog_user` WHERE `name` = &apos;mary&apos; AND `id` &gt; 3
            $res = $this-&gt;db-&gt;where(array(&apos;name&apos;=&gt;&apos;mary&apos;,&apos;id &gt;&apos;=&gt;3))-&gt;get (&apos;user&apos;);
            echo $this-&gt;db-&gt;last_query();

            复杂的查询,则建议用$this-&gt;db-&gt;query($sql,$data);//使用问题?绑定参数的方式查询
</code></pre><h1 id="CI类库扩展"><a href="#CI类库扩展" class="headerlink" title="CI类库扩展"></a><a id="CI类库扩展"></a>CI类库扩展</h1><pre><code>在system目录下的是CI框架的核心文件.如果需要进行扩展,只需要在对应的application目录下对应着system目录下的文件编写对应的类,即可扩展.
例如: application 目录下有core helpers language libraries 目录均于system目录下的文件夹相一一对应.

子类名前缀
    \application\config\config.php 子类名前缀
    $config[&apos;subclass_prefix&apos;] = &apos;MY_&apos;;

例如:扩展控制器
    在application/core/MY_Controller.php 创建自定义的类继承自application/core/Controller.php  (CI_Controller 类名与文件名不同)

    &lt;?php
        class MY_Controller extends CI_Controller{
            //构造方法
            public function __construct(){
                parent::__construct();//调用父类的构造方法
                echo &apos;aaaaaaaaaaaaa&apos;;
                //登录验证
                //权限验证...等等
            }
        }
    然后在application/controllers/目录下的控制器中使用继承自My_Controller的类即可使用,自定义的控制器.
其它类库均类似的扩展.
</code></pre><p><a id="扩展控制器CI_Controller-装载器Loader"></a>案例:为网站设计不同的主题.前台,后台(扩展控制器CI_Controller,装载器Loader)</p>
<pre><code>第一步，指定不同的视图View路径 . 在网站根目录下创建 themes 文件夹和 里面再创建default目录
第二步，定义一个常量，在config/costants.php,如下
    在application/config/constants.php 常量配置文件中配置常量.
    #自定义系统相当常量 (主题目录)
    define(&apos;THEMES_DIR&apos;,&apos;themes/&apos;); //指明视图路径地址.

第三步，扩展CI类
    视图的加载由loader类完成，(\system\core\Loader.php)如下

        CI 2.2.0
            public function __construct()
            {
                $this-&gt;_ci_ob_level  = ob_get_level();
                $this-&gt;_ci_library_paths = array(APPPATH, BASEPATH);
                $this-&gt;_ci_helper_paths = array(APPPATH, BASEPATH);
                $this-&gt;_ci_model_paths = array(APPPATH);
                $this-&gt;_ci_view_paths = array(APPPATH.&apos;views/&apos;    =&gt; TRUE);
            }
        CI 3.0.0
            protected $_ci_view_paths = array(VIEWPATH =&gt; TRUE);

    扩展 Loader 类 (\application\core\MY_Loader.php)
        &lt;?PHP
            defined(&apos;BASEPATH&apos;) OR exit(&apos;No direct script access allowed&apos;);

            class MY_Loader extends CI_Loader{
                //被开启的主题目录
                protected $_theme = &apos;default/&apos;;

                public function switch_themes_on(){
                    $this-&gt;_ci_view_paths = array(FCPATH,THEMES_DIR,$this-&gt;_theme =&gt; TRUE);
                }

                public function switch_themes_off(){
                    #just do nothing
                }
            }
    扩展控制器
        &lt;?PHP
            defined(&apos;BASEPATH&apos;) OR exit(&apos;No direct script access allowed&apos;);

            //前台控制器
            class HomeController extends CI_Controller{
                public function __construct(){
                    parent::__construct();
                    #开启皮肤功能
                    $this-&gt;load-&gt;switch_themes_on();
                }
            }

            //后台控制器
            class AdminController extends CI_Controller{
                public function __construct(){
                    parent::__construct();
                    #关闭皮肤功能
                    $this-&gt;load-&gt;switch_themes_off();    
                }
            }

第四步: 编写不同的控制器
    application/controllers 下编写前台控制器 并继承 HomeController 
    application/controllers/admin 编写后台控制器 并继承 AdminController


第五步: 编写不同的视图文件.
     themes/default/ 目录下编写前台视图View 
     application/views 目录下编写后台试图View

而模型 model 是共用的.    
</code></pre><p>案例:<a href="#扩展CI的captcha_helper.php实现_验证码">扩展CI的captcha<em>helper.php实现</em>验证码</a>        </p>
<h1 id="url相关函数"><a href="#url相关函数" class="headerlink" title="url相关函数"></a><a id="url相关函数"></a>url相关函数</h1><pre><code>http://codeigniter.org.cn/user_guide/helpers/url_helper.html

//加载url帮助类 //默认在辅助函数/URL辅助函数中,默认不加载.
$this-&gt;load-&gt;helper(&apos;url&apos;);//使用前需要加载标准类,或者配置自动加载
    \application\config\autoload.php 文件中配置
    $autoload[&apos;helper&apos;] = array(&apos;url&apos;);

base_url();//返回网站根目录 application\config\config.php中: $config[&apos;base_url&apos;]=&apos;&apos;; 中配置的目录
//http://127.0.0.1:8000/CodeIgniter-3.0.0

site_url(&apos;控制器/方法&apos;) //返回 base_url/index_page/控制器/方法 ($config[&apos;index_page&apos;] = &apos;index.php&apos;;)
//如 http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php

案例:
\application\controllers\url_demo_controllers.php
&lt;?php
    class Url_demo_controllers extends CI_Controller{
        //http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/Url_demo_controllers
        public function index(){
            //加载url帮助类
            $this-&gt;load-&gt;helper(&apos;url&apos;);
            $this-&gt;load-&gt;view(&apos;user/url_demo&apos;);
        }

        public function insert(){
            var_dump($this-&gt;input-&gt;post(&apos;name&apos;));
        }
    }

\application\views\user\url_demo.php 
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;403 Forbidden&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;!-- &lt;form action=&quot;/CodeIgniter-3.0.0/index.php/Url_demo_controllers/insert&quot; method=&quot;post&quot;&gt; --&gt;
&lt;form action=&quot;&lt;?php echo site_url(&apos;Url_demo_controllers/insert&apos;);?&gt;&quot; method=&quot;post&quot;&gt;
    name&lt;input type=&quot;text&quot; name=&quot;name&quot; /&gt;&lt;br&gt;
    password&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;&lt;br&gt;
    email&lt;input type=&quot;text&quot; name=&quot;email&quot; /&gt;&lt;br&gt;
    &lt;button type=&quot;submit&quot;&gt;submit&lt;/button&gt;
&lt;/form&gt;

&lt;!--     &lt;img alt=&quot;&quot; src=&quot;/CodeIgniter-3.0.0/uploads/logo.jpg&quot;/&gt; --&gt;
    &lt;img alt=&quot;&quot; src=&quot;&lt;?php echo base_url();?&gt;uploads/logo.jpg&quot; width=&quot;100&quot;/&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h1 id="设置路由"><a href="#设置路由" class="headerlink" title="设置路由"></a><a id="设置路由"></a>设置路由</h1><pre><code>路由配置文件
    application/config/routes.php

默认控制器 配置
    $route[&apos;default_controller&apos;] = &apos;welcome&apos;;

实现伪静态
    $route[&apos;news/[\d]{6}/([\d]+)/([^\s]+)&apos;]=&apos;routes_demo/showTwice/$1/$2&apos;;
    //URL中的地址=对应的控制器/方法/参数 --  第一个() 对应$1 以此类推

    案例: 

    &lt;?php
        class Routes_demo extends CI_Controller {
            // http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/routes_demo
            public function index() {
                echo &apos;routes_demo index &apos;;
            }

            // 路由配置目录 application/config/routes.php

            // 原地址: http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/routes_demo/show/2
            // 路由映射地址:
            // http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/news/2.html
            // 路由配置: $route[&apos;news/([\d]+)\.html&apos;]=&apos;routes_demo/show/$1&apos;;
            // http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/news/201515/2.html
            // 路由配置: $route[&apos;news/[\d]{6}/([\d]+)\.html&apos;]=&apos;routes_demo/show/$1&apos;;
            public function show($id = 0) {
                echo &apos;这是文章&apos; . $id;
            }

            // 原地址:
            // http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/routes_demo/showTwice/4/.jpg
            // 路由映射地址:
            // http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/news/201501/4/.jpg
            // 路由配置: $route[&apos;news/[\d]{6}/([\d]+)/([^\s]+)&apos;]=&apos;routes_demo/showTwice/$1/$2&apos;;
            public function showTwice($id = 0, $res = &apos;&apos;) {
                echo &apos;这是文章&apos; . $id . $res;
            }
        }
</code></pre><h1 id="隐藏入口文件-index-php"><a href="#隐藏入口文件-index-php" class="headerlink" title="隐藏入口文件-index.php"></a><a id="隐藏入口文件-index.php"></a>隐藏入口文件-index.php</h1><pre><code>如原地址为:
    http://127.0.0.1:8000/CodeIgniter-3.0.0/index.php/routes_demo
隐藏入口文件后只需要把地址写成即可:
    http://127.0.0.1:8000/CodeIgniter-3.0.0/routes_demo

1.需要开启Apache的 rewrite 功能 Apache2.2\conf\httpd.conf 修改如下: 
    修改前:
        #LoadModule rewrite_module modules/mod_rewrite.so

        ...
        # AllowOverride controls what directives may be placed in .htaccess files.
        # It can be &quot;All&quot;, &quot;None&quot;, or any combination of the keywords:
        #   Options FileInfo AuthConfig Limit

        AllowOverride None
        ...

    修改成:
        # 搜索 mod_rewrite 与 .htaccess 关键字来进行查询修改项
        LoadModule rewrite_module modules/mod_rewrite.so

        &lt;Directory &quot;E:/ComTu_Design/PHP/Apache2.2/htdocs&quot;&gt;
            Options Indexes FollowSymLinks
            # AllowOverride controls what directives may be placed in .htaccess files.
            # It can be &quot;All&quot;, &quot;None&quot;, or any combination of the keywords:
            #   Options FileInfo AuthConfig Limit

            AllowOverride all
            Order allow,deny
            Allow from all
        &lt;/Directory&gt;

    重启Apache.

2.在入口文件同级目录(system/application同级目录)中,放入一个.htaccess 内容如下:
    (技巧如果自己编写创建一个点.开头的文件可以使用记事本另存为的方式输入双引号&quot;.htaccess&quot;保存即可)
    &lt;IfModule mod_rewrite.c&gt;
        RewriteEngine on
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(.*)$ index.php/$1 [QSA,PT,L]
    &lt;/IfModule&gt;

3.配置索引页 \application\config\config.php 
    原: 
        $config[&apos;index_page&apos;] = &apos;index.php&apos;;
    修改成: 
        $config[&apos;index_page&apos;] = &apos;&apos;;
</code></pre><h1 id="分页"><a href="#分页" class="headerlink" title="分页"></a><a id="分页"></a>分页</h1><pre><code>http://codeigniter.org.cn/user_guide/libraries/pagination.html
直接见源代码:

\application\controllers\paging_demo.php
&lt;?php
    class Paging_demo extends CI_Controller {
        public function index() {
        }
        //http://127.0.0.1:8000/CodeIgniter-3.0.0/paging_demo/paging
        public function paging() {
            // 装载类文件
            $this-&gt;load-&gt;library ( &apos;pagination&apos; );
            // 每页显示10条数据
            $page_size = 10;

            $this-&gt;load-&gt;helper(&apos;url&apos;);
            //配置页面
            $config [&apos;base_url&apos;] = site_url(&apos;paging_demo/paging&apos;);
            //一共有多少条数据
            $config [&apos;total_rows&apos;] = &apos;200&apos;;
            //每页显示条数
            $config [&apos;per_page&apos;] = $page_size;

            //分页的数据查询偏移量在哪一段上
            $config[&apos;uri_seqment&apos;] = 3;

            $config[&apos;first_link&apos;] = &apos;首页&apos;;
            $config[&apos;next_link&apos;] = &apos;下一页&apos;;
            $config[&apos;last_link&apos;] = &apos;最后一页&apos;;

            $this-&gt;pagination-&gt;initialize ( $config );

            //http://127.0.0.1:8000/CodeIgniter-3.0.0/paging_demo/paging/190
            //获取链接地址第三段的参数190 与配置$config[&apos;uri_seqment&apos;]相对应
            $offset = intval($this-&gt;uri-&gt;segment(3));//intval函数获取数字,无则返回0

            //拼接Sql查询语句
            $sql = &quot;select * from blog_user limit $offset , $page_size&quot;;
            echo $sql.&apos;&lt;br&gt;&apos;;

            //生成链接
            $data[&apos;links&apos;]=$this-&gt;pagination-&gt;create_links ();
            //在页面中显示
            $this-&gt;load-&gt;view(&apos;user/paging_view&apos;,$data);
        }
    }

    \application\views\user\paging_view.php
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;分页&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;?=$links ?&gt;
    &lt;/body&gt;
    &lt;/html&gt;
</code></pre><p><a id="扩展_修改分页生成的代码"></a>扩展_修改分页生成的代码</p>
<pre><code>拷贝system/libraries/Pagination.php 到 application/libraries/目录 直接修改如下:
    这样做之后CI会自动查找到application/libraries/Pagination.php 做为分页类.
CI 3.0.0
    //Generate the pagination links
    public function create_links(){//398行
        //省略很多代码.
        //原: //650行
        //return $this-&gt;full_tag_open.$output.$this-&gt;full_tag_close;

        //修改如下: 自定义内容 当然,发挥自己的想象去修改
        $baseinfo = &quot;总共 $this-&gt;total_rows 条记录，每页显示 $this-&gt;per_page 条，
        总计 $num_pages 页，当前是第  $this-&gt;cur_page 页&quot;.&apos;&amp;nbsp;&amp;nbsp;&amp;nbsp;&apos;;
        return $baseinfo.$this-&gt;full_tag_open.$output.$this-&gt;full_tag_close;
    }
CI 2.2.0
    function create_links(){//115行
        //省略很多代码.
        // Add the wrapper HTML if exists //331行
        //$output = $this-&gt;full_tag_open.$output.$this-&gt;full_tag_close;
        //return $output;

        //修改如下: 自定义内容 当然,发挥自己的想象去修改
        $baseinfo = &quot;总共 $this-&gt;total_rows 条记录，每页显示 $this-&gt;per_page 条，
        总计 $num_pages 页，当前是第  $this-&gt;cur_page 页&quot;.&apos;&amp;nbsp;&amp;nbsp;&amp;nbsp;&apos;;
        return $baseinfo.$output;
    }
</code></pre><h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a><a id="文件上传"></a>文件上传</h1><pre><code>http://codeigniter.org.cn/user_guide/libraries/file_uploading.html

案例见代码: 
\application\controllers\upload_demo.php
&lt;?php
class Upload_demo extends CI_Controller {
    public function index() {
    }

    // http://127.0.0.1:8000/CodeIgniter-3.0.0/upload_demo/file
    public function file() {
        $data [&apos;error&apos;] = &apos;&apos;;
        $data [&apos;upload_data&apos;] = &apos;&apos;;

        $this-&gt;load-&gt;helper ( &apos;url&apos; );
        $this-&gt;load-&gt;view ( &apos;user/upload_view_demo&apos;, $data );
    }
    public function upload() {
        // 上传目录需要手动创建
        $config [&apos;upload_path&apos;] = &apos;./uploads/&apos;;
        $config [&apos;allowed_types&apos;] = &apos;gif|jpg|png&apos;;
        $config [&apos;max_size&apos;] = 100;//kb
        $config [&apos;max_width&apos;] = 1024;
        $config [&apos;max_height&apos;] = 768;
        // 上传后的文件名/不设置则默认原文件名,如果文件名冲突,则会在文件名中加入递增数字
        //$config [&apos;file_name&apos;] = uniqid (); 

        $this-&gt;load-&gt;library ( &apos;upload&apos;, $config );

        $this-&gt;upload-&gt;do_upload ( &apos;pic&apos; );//上传的input name
        $this-&gt;upload-&gt;do_upload ( &apos;pic2&apos; );//上传的input name

        $data = array (
                &apos;upload_data&apos; =&gt; $this-&gt;upload-&gt;data () ,//上传成功
                &apos;error&apos; =&gt; $this-&gt;upload-&gt;display_errors ()//错误信息
        );
        $this-&gt;load-&gt;view ( &apos;user/upload_view_demo&apos;, $data );
    }
}

\application\views\user\upload_view_demo.php
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;文件上传&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;?php 
    if($error){    echo $error;}
    ?&gt;

    &lt;form action=&quot;&lt;?php echo site_url(&apos;upload_demo/upload&apos;)?&gt;&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
        &lt;input type=&quot;file&quot; name=&quot;pic&quot; /&gt;&lt;/br&gt;
        &lt;input type=&quot;file&quot; name=&quot;pic2&quot; /&gt;&lt;/br&gt;
        &lt;input type=&quot;submit&quot; name=&quot;上传&quot; /&gt;
    &lt;/form&gt;

    &lt;?php if ($upload_data):?&gt;
        &lt;?php foreach ($upload_data as $item =&gt; $value):?&gt;
            &lt;li&gt;&lt;?php echo $item;?&gt;: &lt;?php echo $value;?&gt;&lt;/li&gt;
        &lt;?php endforeach; ?&gt;
    &lt;?php endif ?&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h1 id="图片处理类"><a href="#图片处理类" class="headerlink" title="图片处理类"></a><a id="图片处理类"></a>图片处理类</h1><pre><code>$config[&apos;image_library&apos;] = &apos;gd2&apos;;
$config[&apos;source_image&apos;] = &apos;/path/to/image/mypic.jpg&apos;;
$config[&apos;create_thumb&apos;] = TRUE;
$config[&apos;maintain_ratio&apos;] = TRUE;
$config[&apos;width&apos;] = 75;
$config[&apos;height&apos;] = 50;

$this-&gt;load-&gt;library(&apos;image_lib&apos;, $config); 

$this-&gt;image_lib-&gt;resize();  //创建缩略图  
// $this-&gt;image_lib-&gt;crop() //图像裁剪
// $this-&gt;image_lib-&gt;rotate() //图像旋转 
// $this-&gt;image_lib-&gt;watermark() //添加图像水印
// $this-&gt;image_lib-&gt;clear()  //clear函数重置所有之前用于处理图片的值。当你用循环来处理一批图片时，你可能会想使用它。

//处理不同的图片有不同的配置,详情见文档
http://codeigniter.org.cn/user_guide/libraries/image_lib.html


//获取相应属性
$this-&gt;image_lib-&gt;thumb_marker; 
//错误信息
$this-&gt;image_lib-&gt;display_errors();
</code></pre><h1 id="Session"><a href="#Session" class="headerlink" title="Session"></a><a id="Session"></a>Session</h1><pre><code>http://codeigniter.org.cn/user_guide/libraries/sessions.html
Session 类将每个用户的 session 信息序列化（serialize）后存储到到 cookie 中（并同时进行加密）。

ci的Session是存储到cookie中.PHP原生的session是放到服务器中.
所以需要加密.可查看值,但不能修改.因为提交时会通过密钥校验数据完整性.

配置 \application\config\config.php

    配置Session加密(CI2.2可配置,CI3.0.0抛弃了此功能):
        原:
            $config[&apos;sess_encrypt_cookie&apos;]    = FALSE;
        修改为:
            $config[&apos;sess_encrypt_cookie&apos;]    = TRUE;

    配置Session关闭浏览器后失效(CI2.2可配置,CI3.0.0无此配置项):
        原:
            $config[&apos;sess_expire_on_close&apos;] = FALSE;
        修改为:
            $config[&apos;sess_expire_on_close&apos;] = TRUE;

        CI3.0.0 需要如下实现(关闭浏览器销毁session,不关闭或者不退出,则一直有效):
            $config[&apos;sess_expiration&apos;] = 0; 

    配置Session密钥:

        原:
            $config[&apos;encryption_key&apos;] = &apos;&apos;;
        修改密钥(可用echo md5(uniqid());生成一个值当密钥):
            $config[&apos;encryption_key&apos;] = &apos;05c072360c5ac7e19d5b2566a995991c&apos;;

    配置Session文件路径:

        CI3.0.0版本需要配置此项,不然会出现 Message: mkdir() [function.mkdir]: Invalid argument 异常
        CI3.0.0之前版本可以不要设置.(CodeIgniter_2.2.0测试查看,无此参数)

        原:
            $config[&apos;sess_save_path&apos;] = NULL;
        新session路径(注意~~些路径需要要使用绝对路径)
            创建目录用于存储Session:E:\ComTu_Design\PHP\Apache2.2\htdocs\CodeIgniter-3.0.0\application\session
            $config[&apos;sess_save_path&apos;] = &apos;E:\ComTu_Design\PHP\Apache2.2\htdocs\CodeIgniter-3.0.0\application\session&apos;;

        可查看 sess_save_path 配置相关文档
            http://codeigniter.org.cn/user_guide/libraries/sessions.html
            http://php.net/manual/en/session.configuration.php#ini.session.save-path

    //加载模块
    $this-&gt;load-&gt;library(&apos;session&apos;);
    //存储session
    $user = $this-&gt;session-&gt;set_userdata ( &apos;user&apos;, $user );
    //取session
    $user = $this-&gt;session-&gt;userdata(&apos;user&apos;);
    //删除session
    $this-&gt;session-&gt;unset_userdata(&apos;user&apos;);
    $this-&gt;session-&gt;unset_userdata($array_items);//删除多个session
</code></pre><p>Ci的Session实现案例:</p>
<pre><code>案例见代码: 
&lt;?php
class Session_demo extends CI_Controller {
    public function index(){}

    public function __construct(){
        parent::__construct();
        $this-&gt;load-&gt;library(&apos;session&apos;);
    }

    // 先存储session 
    // http://127.0.0.1:8000/CodeIgniter-3.0.0/session_demo/set_session
    // 在取出sesson(刷新演示一次性的数据)
    // http://127.0.0.1:8000/CodeIgniter-3.0.0/session_demo/show_session
    public function set_session() {
        //echo md5(uniqid());exit;

        $user = array(&apos;id&apos;=&gt;3,&apos;name&apos;=&gt;&apos;jack&apos;);

        // 相当于原生的:
        // session_start();
        // $_SESSION[&quot;user&quot;] = $user;

        $user = $this-&gt;session-&gt;set_userdata ( &apos;user&apos;, $user );
        var_dump($user);//取出来NULL
        echo &apos;&lt;br&gt;&apos;;

        //取session
        $user = $this-&gt;session-&gt;userdata(&apos;user&apos;);
        var_dump($user);

        //一次性的数据,只能读一次
        $this-&gt;session-&gt;set_flashdata(&apos;test&apos;,&apos;testdate-aaaaaaaaaaaa&apos;);
    }

    //http://127.0.0.1:8000/CodeIgniter-3.0.0/session_demo/show_session
    public function show_session(){
        //获取CI session中的数据
        $user = $this-&gt;session-&gt;userdata(&apos;user&apos;);
        var_dump($user);

        //只可以取一次,取完后就会被删除.
        $test=$this-&gt;session-&gt;flashdata(&apos;test&apos;);
        var_dump($test);
    }

    public function delete_session(){
        //删除单个session
        $this-&gt;session-&gt;unset_userdata(&apos;user&apos;);

        // //删除多个session
        // $array_items = array(&apos;user&apos;, &apos;test&apos;);
        // $this-&gt;session-&gt;unset_userdata($array_items);
    }

    public function originalPHPsession(){
        // 原生session
        session_start();
        //存储验证码信息到PHP原生的session中.
        $_SESSION[&quot;cap&quot;] = &apos;abc&apos;;

        //获取Session
        $word = $_SESSION[&apos;cap&apos;];
        echo $word;

        //终结 Session
        unset($_SESSION[&apos;cap&apos;]);
        //重置session  , 失去所有已存储的 session 数据。
        //session_destroy();
    }
}
</code></pre><h1 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a><a id="验证码"></a>验证码</h1><pre><code>ci的验证码会创建一个图片文件,所以需要创建文件夹用来存放
    E:\ComTu_Design\PHP\Apache2.2\htdocs\CodeIgniter-3.0.0\captcha

使用CI验证码需要开启PHP的 GD 图像库
    可用PHP代码检测是否开启GD图像库
        if(extension_loaded(&apos;gd&apos;)){
            echo &apos;你可以使用gd&lt;br&gt;&apos;;
            foreach (gd_info() as $cate=&gt;$value)
                echo &quot;$cate: $value&lt;br&gt;&quot;;
        }else echo &apos;没有安装gd扩展&apos;;

    开启 GD 图像库 方法:
        E:\ComTu_Design\PHP\php-5.3.5\php.ini 配置文件修改如下:
        原: 
            ;extension=php_gd2.dll
        修改成(去除前面的;分号): 
            extension=php_gd2.dll
        修改完后保存,重启apache
</code></pre><p>CI默认实现:</p>
<pre><code>//加载模块
$this-&gt;load-&gt;helper(&apos;captcha&apos;);
//创建验证码
$cap = create_captcha($vals);
//显示验证码
echo $cap[&apos;image&apos;];

案例见代码: 
&lt;?php
class Captcha_demo extends CI_Controller{
    public function index(){}

    public function test(){
        echo &apos;captcha_demo&apos;;

        if(extension_loaded(&apos;gd&apos;)){
            echo &apos;你可以使用gd&lt;br&gt;&apos;;
            foreach (gd_info() as $cate=&gt;$value)
                echo &quot;$cate: $value&lt;br&gt;&quot;;
        }else echo &apos;没有安装gd扩展&apos;;

        $this-&gt;load-&gt;helper(&apos;url&apos;);
        $this-&gt;load-&gt;helper(&apos;captcha&apos;);
        $number = rand(1000,9999);//生成随机字符串
        $vals = array(
                &apos;word&apos;      =&gt; $number,//可指定验证码内容,如果是中文.需要有支持的字体
                &apos;img_path&apos;  =&gt; dirname(BASEPATH).&apos;/captcha/&apos;,//生成的图片存放目录,手动创建
                &apos;img_url&apos;   =&gt; base_url(&apos;/captcha/&apos;),//图片链接地址
                //&apos;font_path&apos; =&gt; &apos;./path/to/fonts/texb.ttf&apos;,//指定字体_如果使用中文需要指定字体
                &apos;img_width&apos; =&gt; &apos;150&apos;,
                &apos;img_height&apos;    =&gt; 30,
                &apos;expiration&apos;    =&gt; 5,//图片存放时间,如果过期,只有在被再次请求才会删除.单位秒
                &apos;word_length&apos;   =&gt; 8,
                &apos;font_size&apos; =&gt; 16,
                &apos;img_id&apos;    =&gt; &apos;Imageid&apos;,
                &apos;pool&apos;      =&gt; &apos;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;,

                // White background and border, black text and red grid
                &apos;colors&apos;    =&gt; array(
                        &apos;background&apos; =&gt; array(255, 255, 255),
                        &apos;border&apos; =&gt; array(255, 255, 255),
                        &apos;text&apos; =&gt; array(0, 0, 0),
                        &apos;grid&apos; =&gt; array(255, 40, 40)
                )
        );

        $cap = create_captcha($vals);
        echo $cap[&apos;word&apos;].&quot;&lt;br&gt;&quot;;
        echo $cap[&apos;image&apos;];

        $this-&gt;load-&gt;view(&apos;user/captcha_view_demo&apos;,array(&apos;cap&apos;=&gt;$cap[&apos;image&apos;]));

        // 原生session
        session_start();
        //存储验证码信息到PHP原生的session中.等待校验.
        $_SESSION[&quot;cap&quot;] = $cap[&apos;word&apos;];

        //获取Session
        $word = $_SESSION[&apos;cap&apos;];
        echo $word;
    }
}
</code></pre><p><a id="扩展CI的captcha_helper.php实现_验证码"></a>扩展CI的captcha<em>helper.php实现</em>验证码:</p>
<pre><code>一般而言,对于验证码只需要用一次,没必要创建一张图片保存到本地.
所以我对验证码类进行了如下扩展: 不存储验证码图片,并实现点击重新获取验证码.

步骤一: 

    把 system/helpers/captcha_helper.php 文件拷贝到 application/helpers/ 目录下并重命名为:MY_captcha_helper.php

步骤二:  去除与目录有关的代码

    修改 MY_captcha_helper.php 里面的源文件进行如下操作:

    (CI 3.0.0)
        //处理如果没有设置图片路径而被返回的操作
        //         if ($img_path === &apos;&apos; OR $img_url === &apos;&apos;
        //             OR ! is_dir($img_path) OR ! is_really_writable($img_path)
        //             OR ! extension_loaded(&apos;gd&apos;))
        //         {
        //             return FALSE;
        //         }
        //         // -----------------------------------
        //         // Remove old images
        //         // 删除旧图片
        //         // -----------------------------------
        //         $now = microtime(TRUE);
        //         $current_dir = @opendir($img_path);
        //         while ($filename = @readdir($current_dir))
        //         {
        //             if (substr($filename, -4) === &apos;.jpg&apos; &amp;&amp; (str_replace(&apos;.jpg&apos;, &apos;&apos;, $filename) + $expiration) &lt; $now)
        //             {
        //                 @unlink($img_path.$filename);
        //             }
        //         }
        //         @closedir($current_dir);

        // -----------------------------------
        //  Generate the image
        // 生成图片.
        // -----------------------------------
        //处理生成图片--start--
        //         $img_url = rtrim($img_url, &apos;/&apos;).&apos;/&apos;;
        //         if (function_exists(&apos;imagejpeg&apos;))
        //         {
        //             $img_filename = $now.&apos;.jpg&apos;;
        //             imagejpeg($im, $img_path.$img_filename);
        //         }
        //         elseif (function_exists(&apos;imagepng&apos;))
        //         {
        //             $img_filename = $now.&apos;.png&apos;;
        //             imagepng($im, $img_path.$img_filename);
        //         }
        //         else
        //         {
        //             return FALSE;
        //         }
        //         $img = &apos;&lt;img &apos;.($img_id === &apos;&apos; ? &apos;&apos; : &apos;id=&quot;&apos;.$img_id.&apos;&quot;&apos;).&apos; src=&quot;&apos;.$img_url.$img_filename.&apos;&quot; style=&quot;width: &apos;.$img_width.&apos;; height: &apos;.$img_height .&apos;; border: 0;&quot; alt=&quot; &quot; /&gt;&apos;;
        //         ImageDestroy($im);
        //         return array(&apos;word&apos; =&gt; $word, &apos;time&apos; =&gt; $now, &apos;image&apos; =&gt; $img, &apos;filename&apos; =&gt; $img_filename);
        //处理生成图片--end--
        //并在此处 增加如下四行代码,告诉浏览器返回的是一张图片.
        header(&quot;Content-Type:image/jpeg&quot;);  
        imagejpeg($im);
        ImageDestroy($im);
        return $word;//返回生成的验证码字符串


    (CI 2.2.0)
        //处理如果没有设置图片路径而被返回的操作
        // if ($img_path == &apos;&apos; OR $img_url == &apos;&apos;){
        //     return FALSE;
        // }
        // if ( ! @is_dir($img_path)){
        //     return FALSE;
        // }
        // if ( ! is_writable($img_path)){
        //     return FALSE;
        // }
        // if ( ! extension_loaded(&apos;gd&apos;)){
        //     return FALSE;
        // }
        // // -----------------------------------
        // // Remove old images
        // // 生成图片.
        // // -----------------------------------
        // list($usec, $sec) = explode(&quot; &quot;, microtime());
        // $now = ((float)$usec + (float)$sec);
        // $current_dir = @opendir($img_path);
        // while ($filename = @readdir($current_dir)){
        //     if ($filename != &quot;.&quot; and $filename != &quot;..&quot; and $filename != &quot;index.html&quot;){
        //         $name = str_replace(&quot;.jpg&quot;, &quot;&quot;, $filename);
        //         if (($name + $expiration) &lt; $now){
        //             @unlink($img_path.$filename);
        //         }
        //     }
        // }
        // @closedir($current_dir);

        // -----------------------------------
        //  Generate the image
        // -----------------------------------
        // $img_name = $now.&apos;.jpg&apos;;
        // ImageJPEG($im, $img_path.$img_name);
        // $img = &quot;&lt;img src=\&quot;$img_url$img_name\&quot; width=\&quot;$img_width\&quot; height=\&quot;$img_height\&quot; style=\&quot;border:0;\&quot; alt=\&quot; \&quot; /&gt;&quot;;
        // ImageDestroy($im);
        // return array(&apos;word&apos; =&gt; $word, &apos;time&apos; =&gt; $now, &apos;image&apos; =&gt; $img);
        //并在此处 增加如下四行代码,告诉浏览器返回的是一张图片.
        header(&quot;Content-Type:image/jpeg&quot;);  
        imagejpeg($im);
        ImageDestroy($im);
        return $word;//返回生成的验证码字符串


步骤三: 
    在控制器中使用 captcha
    &lt;?php
    defined(&apos;BASEPATH&apos;) OR exit(&apos;No direct script access allowed&apos;);

    class Privilege extends CI_Controller {
        public function __construct(){
            parent::__construct();
            //载入验证码辅助函数
            $this-&gt;load-&gt;helper(&apos;captcha&apos;);
        }

        public function login(){
            $this-&gt;load-&gt;view(&apos;login&apos;);
        }

        public function code(){
            //创建验证码
            $word = create_captcha();

            //可以在MY_captcha_helper.php直接配置参数也是OK的.
            //当然同样适用于配置参数.但可以免去了 CI文档中的 img_path 与 img_url 这两个必要参数了.
            // $vals = array(
            //     &apos;word&apos;      =&gt; rand(1000,9999),//可指定验证码内容,如果是中文.需要有支持的字体
            //     //&apos;font_path&apos; =&gt; &apos;./path/to/fonts/texb.ttf&apos;,//指定字体_如果使用中文需要指定字体
            //     &apos;img_width&apos; =&gt; &apos;150&apos;,
            //     &apos;img_height&apos;    =&gt; 30,
            //     &apos;expiration&apos;    =&gt; 5,//图片存放时间,如果过期,只有在被再次请求才会删除.单位秒
            //     &apos;word_length&apos;   =&gt; 4, //验证码位数
            //     &apos;font_size&apos; =&gt; 16,
            //     &apos;img_id&apos;    =&gt; &apos;Imageid&apos;,
            //     &apos;pool&apos;      =&gt; &apos;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;,
            //     // White background and border, black text and red grid
            //     &apos;colors&apos;    =&gt; array(
            //     &apos;background&apos; =&gt; array(255, 255, 255),
            //     &apos;border&apos; =&gt; array(255, 255, 255),
            //     &apos;text&apos; =&gt; array(0, 0, 0),
            //     &apos;grid&apos; =&gt; array(255, 40, 40)
            // )
            // );
            //$word = create_captcha($vals);
        }
    }

步骤四: view中显示 .并实现点击图片重新加载新图片的功能:
    &lt;img src=&quot;&lt;?php echo site_url(&apos;admin/privilege/code&apos;);?&gt;&quot; width=&quot;145&quot; height=&quot;20&quot; alt=&quot;CAPTCHA&quot; border=&quot;1&quot;
    onclick= this.src=&quot;&lt;?php echo site_url(&apos;admin/privilege/code&apos;).&apos;/&apos;;?&gt;&quot;+Math.random() style=&quot;cursor: pointer;&quot; title=&quot;看不清？点击更换另一个验证码。&quot;/&gt;
</code></pre><h1 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a><a id="表单验证"></a>表单验证</h1><pre><code>http://codeigniter.org.cn/user_guide/libraries/form_validation.html

实现: 
    //加载模块
    $this-&gt;load-&gt;helper ( array (&apos;form&apos;,&apos;url&apos;) );
    $this-&gt;load-&gt;library ( &apos;form_validation&apos; );
    //设置校验规则,参数一:表单上的名称,参数二:错误信息显示的名称,参数三:校验的规则见标准文档
    //http://codeigniter.org.cn/user_guide/libraries/form_validation.html#id25
    $this-&gt;form_validation-&gt;set_rules(&apos;参数名&apos;,&apos;用户名&apos;,&apos;required&apos;);
    //表单校验 返回true表示校验通过
    $bool = $this-&gt;form_validation-&gt;run();
    //表单校验加载校验规则 使用配置文件 application/config/form_validation.php 如果没有自己创建.
    //$bool = $this-&gt;form_validation-&gt;run(&apos;demo&apos;);//参数名与config文件中的相对应.

    form表单中
        //自动回填内容项
        &lt;?php echo set_value(&apos;参数名&apos;)?&gt;
        //显示错误信息, 参数一:为form中的表单名,参数二,三:参数样式
        &lt;?php echo form_error(&apos;参数名&apos;,&apos;&lt;span&gt;&apos;,&apos;&lt;/span&gt;&apos;)?&gt;
        //显示全部错误信息
        &lt;?php echo validation_errors();?&gt;
</code></pre><p>案例见代码: </p>
<pre><code>\application\controllers\form_demo.php
    &lt;?php
    class Form_demo extends CI_Controller {
        public function index() {
        }
        // http://127.0.0.1:8000/CodeIgniter-3.0.0/form_demo/insert
        public function insert() {
            $this-&gt;load-&gt;helper ( array (&apos;form&apos;,&apos;url&apos;) );
            //加载模块
            $this-&gt;load-&gt;library ( &apos;form_validation&apos; );

            // 校验如果这样编写会编写很多规则代码.可以在config进行配置验证文件.也可实现重复利用的效果
            // $this-&gt;form_validation-&gt;set_rules(&apos;name&apos;,&apos;用户名&apos;,&apos;required&apos;);
            // $this-&gt;form_validation-&gt;set_rules(&apos;password&apos;,&apos;密码&apos;,&apos;required|min_length[6]|max_length[16]|md5&apos;);
            //$this-&gt;form_validation-&gt;set_rules(&apos;repassword&apos;,&apos;确认密码&apos;,&apos;trim|required|md5|matches[password]&apos;);//重复密码验证
            // $this-&gt;form_validation-&gt;set_rules(&apos;email&apos;,&apos;邮箱&apos;,array(&apos;required&apos;,&apos;valid_email&apos;));
            // // 表单验证
            // $bool = $this-&gt;form_validation-&gt;run();

            // 表单验证配置文件 application/config/form_validation.php
            $bool = $this-&gt;form_validation-&gt;run(&apos;demo&apos;);
            if ($bool) {
                // 调用模型保存数据库
                echo &apos;success&apos;;
            } else {
                // 显示错误信息
                $this-&gt;load-&gt;view ( &apos;user/form_view_demo&apos; );
            }

            echo $bool;
        }
    }

--------
\application\views\user\form_view_demo.php
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;表单验证&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
    &lt;?php echo validation_errors();?&gt;

    &lt;form action=&quot;&lt;?php echo site_url(&apos;form_demo/insert&apos;);?&gt;&quot; method=&quot;post&quot;&gt;
        name&lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;&lt;?php echo set_value(&apos;name&apos;)?&gt;&quot;/&gt;
        &lt;?php echo form_error(&apos;name&apos;,&apos;&lt;span&gt;&apos;,&apos;&lt;/span&gt;&apos;)?&gt;
        &lt;br&gt;
        password&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;
        &lt;?php echo form_error(&apos;password&apos;,&apos;&lt;span&gt;&apos;,&apos;&lt;/span&gt;&apos;)?&gt;
        &lt;br&gt;
        email&lt;input type=&quot;text&quot; name=&quot;email&quot; value=&quot;&lt;?php echo set_value(&apos;email&apos;)?&gt;&quot;/&gt;
        &lt;?php echo form_error(&apos;email&apos;,&apos;&lt;span&gt;&apos;,&apos;&lt;/span&gt;&apos;)?&gt;
        &lt;br&gt;
        &lt;button type=&quot;submit&quot;&gt;submit&lt;/button&gt;
    &lt;/form&gt;
    &lt;/body&gt;
    &lt;/html&gt;
--------
\application/config/form_validation.php
    &lt;?php
        $config = array (
            &apos;demo&apos; =&gt; array (
                    array (
                            &apos;field&apos; =&gt; &apos;name&apos;,
                            &apos;label&apos; =&gt; &apos;用户名&apos;,
                            &apos;rules&apos; =&gt; &apos;required&apos; 
                    ) ,
                    array (
                            &apos;field&apos; =&gt; &apos;password&apos;,
                            &apos;label&apos; =&gt; &apos;密码&apos;,
                            &apos;rules&apos; =&gt; &apos;required&apos; 
                    ),
                    array (
                            &apos;field&apos; =&gt; &apos;email&apos;,
                            &apos;label&apos; =&gt; &apos;邮箱&apos;,
                            &apos;rules&apos; =&gt; &apos;required|valid_email&apos; 
                    )
            ),
            &apos;signup&apos;=&gt;array( ....  )
        );
</code></pre><h1 id="语言包"><a href="#语言包" class="headerlink" title="语言包"></a><a id="语言包"></a>语言包</h1><pre><code>如表单错误信息等语言.
    将语言包解压到
        \application\language\zh_cn
    配置语言:
        \application\config\config.php
        原:
            $config[&apos;language&apos;]    = &apos;english&apos;;
        改成
            $config[&apos;language&apos;]    = &apos;zh_cn&apos;;
</code></pre><h1 id="购物车类库"><a href="#购物车类库" class="headerlink" title="购物车类库"></a><a id="购物车类库"></a>购物车类库</h1><pre><code>http://codeigniter.org.cn/user_guide/libraries/cart.html

CI3.0.0 官方上标注: 之后购物车类已经废弃，请不要使用。目前保留它只是为了向前兼容。

引入购物车支持库
$this-&gt;load-&gt;library(&apos;cart&apos;);
//$autoload[&apos;libraries&apos;] = array(&apos;cart&apos;);//或者配置 application/config/autoload.php

加入购物车
    //名称有要求
    $data[&apos;id&apos;] = $this-&gt;input-&gt;post(&apos;goods_id&apos;,true); //id
    $data[&apos;name&apos;] = $this-&gt;input-&gt;post(&apos;goods_name&apos;,true); //商品名称
    $data[&apos;qty&apos;] = $this-&gt;input-&gt;post(&apos;goods_nums&apos;,true); //数量
    $data[&apos;price&apos;] = $this-&gt;input-&gt;post(&apos;shop_price&apos;,true); //金额

    $goods_thumb= $this-&gt;input-&gt;post(&apos;goods_thumb&apos;,true);
    $data[&apos;options&apos;] = array(&apos;goods_thumb&apos;=&gt;$goods_thumb);//更多信息

    if($this-&gt;cart-&gt;insert($data)){
        echo &apos;ok&apos;;
    }else{
        echo &apos;error&apos;;
    }

//获取购物车数据
$data[&apos;carts&apos;] = $this-&gt;cart-&gt;contents();

//view中获取展示数据
&lt;?php foreach ($carts as $v):?&gt;
    &lt;?php echo base_url(&apos;public/uploads&apos;).&apos;/&apos;.$v[&apos;options&apos;][&apos;goods_thumb&apos;];?&gt;
    &lt;?php echo $v[&apos;id&apos;];?&gt;
    &lt;?php echo $v[&apos;name&apos;];?&gt; 
    &lt;?php echo $v[&apos;price&apos;];?&gt;
    &lt;?php echo $v[&apos;qty&apos;];?&gt;
    &lt;!-- 自动生成 --&gt;
    &lt;?php echo $v[&apos;row_id&apos;];?&gt;
    &lt;!-- 自动生成 $v[&apos;subtotal&apos;] 会自动计算出总金额--&gt;
    &lt;?php echo $v[&apos;subtotal&apos;]?&gt;
&lt;?php endforeach;?&gt;

删除/修改购物车
    $data[&apos;rowid&apos;] = $rowid;
    $data[&apos;qty&apos;] = 0;
    $this-&gt;cart-&gt;update($data);
    redirect(&apos;cart/show&apos;);

注意事项:

    1. 中文问题(2.2.0存在,3.0.0不存在)
        $data[&apos;name&apos;] = $this-&gt;input-&gt;post(&apos;goods_name&apos;,true); //商品名称
        中name项在 CI3.0.0之前是不支持中文内容的. CI3.0.0版本可支持中文.
        CI2.2.0修改cart.php原文件来使name支持中文.
            方法: system/library/Cart.php 拷贝到 application/library 中,找到如下代码并注释即可.

                // Validate the product name. It can only be alpha-numeric, dashes, underscores, colons or periods.
                // Note: These can be user-specified by setting the $this-&gt;product_name_rules variable.
                //CI2.2.0的原代码在186行数
                //if ( ! preg_match(&quot;/^[&quot;.$this-&gt;product_name_rules.&quot;]+$/i&quot;, $items[&apos;name&apos;]))
                //{
                //    log_message(&apos;error&apos;, &apos;An invalid name was submitted as the product name:
                //    &apos;.$items[&apos;name&apos;].&apos; The name can only contain alpha-numeric
                //    characters, dashes, underscores, colons, and spaces&apos;);
                //    return FALSE;
                //}
    2.total_items 问题 (CI2.2.0与CI3.0.0都存在)
        显示购物车中商品数量。 CI框架中默认是显示出商品数量总数
        即:如果存放到购物车2双鞋子+1条裤子 &lt;?php echo $this-&gt;cart-&gt;total_items();?&gt; 获取出来的数据是3件物品,而不是2种商品
        而如果你的需求是 显示商品种类 .需要修改源代码.
            方法: system/library/Cart.php 拷贝到 application/library 中,找到如下代码修改:
                CI3.0.0
                    //代码位置在401行 _save_cart 函数中
                    $this-&gt;_cart_contents[&apos;cart_total&apos;] += ($val[&apos;price&apos;] * $val[&apos;qty&apos;]);
                    //$this-&gt;_cart_contents[&apos;total_items&apos;] += $val[&apos;qty&apos;];  //原代码
                    $this-&gt;_cart_contents[&apos;total_items&apos;] ++;  //新代码
                    $this-&gt;_cart_contents[$key][&apos;subtotal&apos;] = 
                    ($this-&gt;_cart_contents[$key][&apos;price&apos;] * $this-&gt;_cart_contents[$key][&apos;qty&apos;]);

                CI2.2.0
                    //代码位置在386行 _save_cart 函数中
                    $total += ($val[&apos;price&apos;] * $val[&apos;qty&apos;]);
                    //$items += $val[&apos;qty&apos;];//原代码
                    $items ++;//新代码

    3.在我们向购物车中添加商品的时候，如果添加了已经存在于购物车中的商品时，会出现逻辑错误。
        理论上应该是累加，但实际上是将原来的商品信息给删除了。所以要相应的处理一下：    

            // 获取/封装数据....
            //在插入之前,需要判断即将要加入的商品是否已经存在于购物车中
            $carts = $this-&gt;cart-&gt;contents();
            foreach ($carts as $v){
                if($v[&apos;id&apos;] == $data[&apos;id&apos;]){
                    $data[&apos;qty&apos;] += $v[&apos;qty&apos;];
                }
            }
            // 插入数据...
</code></pre><h1 id="CI框架内部解析"><a href="#CI框架内部解析" class="headerlink" title="CI框架内部解析"></a><a id="CI框架内部解析"></a>CI框架内部解析</h1><pre><code>CI是一个单入口框架,所有的请求都需要经常index.php文件 . 流程如下:
              | --&gt; Routing --&gt; Scourity --&gt;     |-----------------------|
    index.php |                                  |Application Controller |--&gt;Drivers,Models,Libaies,Helpers,Packages,Scripts
              | &lt;-- Caching &lt;--   View   &lt;--     |-----------------------|     
</code></pre><p>分析index.php文件.</p>
<pre><code>$system_path = &apos;system&apos;;
$application_folder = &apos;application&apos;;
这个和我们的文件夹结构名称一一对应. 当然这个名称是可以更改.

中间加载一些系统目录常量等.
在index.php结尾尝试打印里面的内容.

        var_dump(SELF , ENVIRONMENT ,BASEPATH ,FCPATH,  SYSDIR);
        exit();
    结果
        string(9) &quot;index.php&quot;
        string(11) &quot;development&quot;
        string(62) &quot;E:/ComTu_Design/PHP/Apache2.2/htdocs/CodeIgniter-3.0.0/system/&quot;
        string(55) &quot;E:\ComTu_Design\PHP\Apache2.2\htdocs\CodeIgniter-3.0.0/&quot;
        string(6) &quot;system&quot;

最后载入
    require_once BASEPATH.&apos;core/CodeIgniter.php&apos;;
</code></pre><p>分析CodeIgniter.php</p>
<pre><code>载入Common.php 通用函数库.        
    require_once(BASEPATH.&apos;core/Common.php&apos;);
        例如:    is_php($version) php版本
            is_really_writable 是否可写
            load_class 载入类函数
            等等

载入配置文件(常量配置)
    require_once(APPPATH.&apos;config/constants.php&apos;);

载入核心类文件.
    $BM =&amp; load_class(&apos;Benchmark&apos;, &apos;core&apos;); 
    $EXT =&amp; load_class(&apos;Hooks&apos;, &apos;core&apos;);  勾子类
    $CFG =&amp; load_class(&apos;Config&apos;, &apos;core&apos;); 配置文件类
    $UNI =&amp; load_class(&apos;Utf8&apos;, &apos;core&apos;); 编码类
    $URI =&amp; load_class(&apos;URI&apos;, &apos;core&apos;); URI类
    $RTR =&amp; load_class(&apos;Router&apos;, &apos;core&apos;, isset($routing) ? $routing : NULL); 路由类
    $OUT =&amp; load_class(&apos;Output&apos;, &apos;core&apos;); 输出类
    $SEC =&amp; load_class(&apos;Security&apos;, &apos;core&apos;); 安全类 
    $IN  =&amp; load_class(&apos;Input&apos;, &apos;core&apos;);输入类
    $LANG =&amp; load_class(&apos;Lang&apos;, &apos;core&apos;);语言类

载入CI总控制器.
    require_once BASEPATH.&apos;core/Controller.php&apos;;

通过router类对象 $RTR的两个方法获取当前的类名和方法名

    CI 2.2.0
        $class  = $RTR-&gt;fetch_class();
        $method = $RTR-&gt;fetch_method();

    CI 3.0.0
        $class = ucfirst($RTR-&gt;class);
        $method = $RTR-&gt;method;

    比如:输入 http://127.0.0.1:8000/CodeIgniter-3.0.0/form_demo/insert 
    那么上述代码获取的$class就是控制器form_demo,$method就是insert , 如果没
    有方法名,则默认index

New了一个对象,叫做CI, 这个就是CI框架中的超级对象(super class)    
    $CI = new $class(); //此处,就是超级对象的形成过程.
    //var_dump($CI); 可以尝试在此处打印一下$CI的信息 . 
</code></pre><p>分析CI_Controller类 Controller.php </p>
<pre><code>        简单的PHP单例设计模式.
            private static $instance;
            public static function &amp;get_instance(){
                return self::$instance;
            }

        构造函数中将前面载入的核心类,作为CI对象的属性.
            foreach (is_loaded() as $var =&gt; $class){
                $this-&gt;$var =&amp; load_class($class);
            }

        然后是载入Loader.php 装载类
            $this-&gt;load =&amp; load_class(&apos;Loader&apos;, &apos;core&apos;);

在控制器中出现的$this就是超级对象.
超级对象形成之后,我们就可以使用超级对象(超级对象的属性)
提供一系列方法完成我们的业务逻辑.如果需要完成其它的功能,可以载入其他的类文件,辅助函数.
这些类文件和辅助函数包括CI已经提供好的.也可以是我们自己定义的.
</code></pre><p>使用中遇到过的问题<br>    CI 3.0.0使用中<br>    访问 views/目录下的文件时被拦截.如<br>    <a href="http://127.0.0.1:8000/mycishop/application/views/images/ecshop_logo.gif" target="_blank" rel="external">http://127.0.0.1:8000/mycishop/application/views/images/ecshop_logo.gif</a></p>
<pre><code>提示:
    Forbidden
    You don&apos;t have permission to access /mycishop/application/views/images/ecshop_logo.gif on this server.

解决办法:
    查看与 views 同级的 .htaccess文件 发现是此处招到的拦截.
    &lt;IfModule authz_core_module&gt;
        Require all denied
    &lt;/IfModule&gt;
    &lt;IfModule !authz_core_module&gt;
        #拦截访问.
        #Deny from all
        #修改成如下代码即可.
        Allow from all 
    &lt;/IfModule&gt;
配置文件与 [隐藏入口文件-index.php](#隐藏入口文件-index.php) 里面的权限管理类似.
</code></pre><p>///////////////////////////////数据库附件////////////////////////////////////////////////</p>
<pre><code>/*
 查询数据库

 mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| discuz             |
| mysql              |
| test               |
| wordpress          |
+--------------------+
5 rows in set (0.00 sec)

进入到test数据库

mysql&gt; use test   
Database changed

查看test数据库中的表

mysql&gt; show tables;
Empty set (0.00 sec)

创建表

mysql&gt; 
mysql&gt; CREATE TABLE IF NOT EXISTS bolg_user(
    -&gt;  id INT AUTO_INCREMENT PRIMARY KEY,
    -&gt;  name VARCHAR(255) NOT NULL UNIQUE,
    -&gt;  password CHAR(32) NOT NULL,
    -&gt;  email VARCHAR(255) NOT NULL DEFAULT &apos;&apos;
    -&gt; )ENGINE MyISAM DEFAULT CHARSET=UTF8;
Query OK, 0 rows affected (0.05 sec)

增加数据

mysql&gt;
mysql&gt; 
mysql&gt; INSERT INTO bolg_user (name,password) VALUES (&apos;admin&apos;,md5(&apos;admin&apos;));
Query OK, 1 row affected (0.07 sec)

查看数据库的表

mysql&gt; show tables;
+----------------+
| Tables_in_test |
+----------------+
| bolg_user      |
+----------------+
1 row in set (0.00 sec)

查看数据库结构

mysql&gt; desc bolg_user;
+----------+--------------+------+-----+---------+----------------+
| Field    | Type         | Null | Key | Default | Extra          |
+----------+--------------+------+-----+---------+----------------+
| id       | int(11)      | NO   | PRI | NULL    | auto_increment |
| name     | varchar(255) | NO   | UNI | NULL    |                |
| password | char(32)     | NO   |     | NULL    |                |
| email    | varchar(255) | NO   |     | NULL    |                |
+----------+--------------+------+-----+---------+----------------+
4 rows in set (0.02 sec)

设置编码格式为gbk,解决查看时乱码.
mysql&gt; set names gbk;
Query OK, 0 rows affected (0.00 sec)

查询数据库表中的内容

mysql&gt; select * from bolg_user;
+----+-------+----------------------------------+-------+
| id | name  | password                         | email |
+----+-------+----------------------------------+-------+
|  1 | admin | 21232f297a57a5a743894a0e4a801fc3 |       |
+----+-------+----------------------------------+-------+
1 row in set (0.00 sec)
 * */
</code></pre><p><a href="/res/file/blog/2015/09/10/PHP_codeigniter/CodeIgniter-3.0.0_Demo.rar">本文案例Demo</a></p>
<p><a href="/res/file/blog/2015/09/10/PHP_codeigniter/mycishop.rar">本文案例Demo<em>附加Demo</em>购物商场</a></p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PHP/" rel="tag">#PHP</a>
          
            <a href="/tags/CI/" rel="tag">#CI</a>
          
            <a href="/tags/CodeIgniter/" rel="tag">#CodeIgniter</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/01/01/Java_Android_Studio_IDE.html" rel="next" title="Android Studio 笔记">
                <i class="fa fa-chevron-left"></i> Android Studio 笔记
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/10/10/PHP_Laravel.html" rel="prev" title="PHP学习笔记-Laravel框架">
                PHP学习笔记-Laravel框架 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="/2015/09/10/PHP_codeigniter.html"
           data-title="PHP学习笔记-CI框架" data-url="http://comtu.github.com//2015/09/10/PHP_codeigniter.html">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/res/img/icon.jpg"
               alt="Comtu" />
          <p class="site-author-name" itemprop="name">Comtu</p>
          <p class="site-description motion-element" itemprop="description">The time is passing</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">30</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/comtu" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/comtu" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CodeIgniter框架简介-CI框架"><span class="nav-number">1.</span> <span class="nav-text">CodeIgniter框架简介 ( CI框架 )</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MVC"><span class="nav-number">2.</span> <span class="nav-text">MVC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#控制器-controllers"><span class="nav-number">2.1.</span> <span class="nav-text">控制器-controllers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#视图-views"><span class="nav-number">2.2.</span> <span class="nav-text">视图-views</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型-model"><span class="nav-number">2.3.</span> <span class="nav-text">模型-model</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CI的超级对象-CI的控制器对象CI-Controller"><span class="nav-number">3.</span> <span class="nav-text">CI的超级对象-(CI的控制器对象CI_Controller)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库访问"><span class="nav-number">4.</span> <span class="nav-text">数据库访问</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AR模型操作数据库-active-record-CI3-0之后改名-query-builder-QB模型"><span class="nav-number">5.</span> <span class="nav-text">AR模型操作数据库 active_record (CI3.0之后改名 query_builder QB模型)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CI类库扩展"><span class="nav-number">6.</span> <span class="nav-text">CI类库扩展</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#url相关函数"><span class="nav-number">7.</span> <span class="nav-text">url相关函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设置路由"><span class="nav-number">8.</span> <span class="nav-text">设置路由</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#隐藏入口文件-index-php"><span class="nav-number">9.</span> <span class="nav-text">隐藏入口文件-index.php</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#分页"><span class="nav-number">10.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#文件上传"><span class="nav-number">11.</span> <span class="nav-text">文件上传</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#图片处理类"><span class="nav-number">12.</span> <span class="nav-text">图片处理类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Session"><span class="nav-number">13.</span> <span class="nav-text">Session</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#验证码"><span class="nav-number">14.</span> <span class="nav-text">验证码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#表单验证"><span class="nav-number">15.</span> <span class="nav-text">表单验证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#语言包"><span class="nav-number">16.</span> <span class="nav-text">语言包</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#购物车类库"><span class="nav-number">17.</span> <span class="nav-text">购物车类库</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CI框架内部解析"><span class="nav-number">18.</span> <span class="nav-text">CI框架内部解析</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Comtu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"comtu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  






  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("feqhc8WOUwoueUx9gkNO8kIq-gzGzoHsz", "3Igep5lfuSGHiGQJB0PFjICO");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
